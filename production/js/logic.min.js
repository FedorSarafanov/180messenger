"use strict";function ID(){return String(CryptoJS.MD5(String(Math.random()+Math.random()+Math.random()+Math.random())))}function dia(e,t){return CryptoJS.MD5([e,t].sort().join(""))}$(document).ready(function(){function e(e,t,o){return $.get("/api/get",{user:e,room:t,coff:o},function(e){"END"!=e&&$("article").append($(e))}),!0}function t(e,t){var n=new FormData,s=new XMLHttpRequest,i=$("progress");s.upload.onprogress=function(e){var t=e.loaded/e.total*100;i.val(t),100==t&&i.val(0)};var a=function(e){if(this.readyState==this.DONE)if(200!=this.status)console.log("error !!!");else{var n=JSON.parse(s.responseText);t?o(n.file):$(".c-title").after(magic.fmsg.format(n.file,n.file,n.from,n.data,magic.str.BytesToSize(n.size)))}},r=function(e){console.log("error ...")};n.append("files",e.target.files[0]),n.append("size",e.target.files[0].size),n.append("from",sessionStorage.from),n.append("data",magic.dt.data()),n.append("desc",""),s.open("post","/api/upload",!0),s.addEventListener("error",r,!1),s.send(n),s.addEventListener("readystatechange",a,!1)}function o(e){c.push(e),sessionStorage.attached=JSON.stringify(c),$(".mess").append(magic.magic.fmsgmsg.format(e))}function n(){var e=$("#message_text").val();e.length<=0||(d.val(""),r=u.val(),socket.emit("message",{message:e,from:sessionStorage.from,room:sessionStorage.room,attach:c,to:r,id:ID()}),c=[],sessionStorage.attached=JSON.stringify(c),$("footer a").remove())}function s(e,t){if(e.room==sessionStorage.room&(sessionStorage.from==e.to|e.from==sessionStorage.from|"Всем"==e.to)){var o=magic.msg.format(e,sessionStorage.from,"ученик");t?f.prepend(o):f.append(o)}}var i=0;$(window).scroll(function(){$(window).scrollTop()>=$(document).height()-$(window).height()&$(window).scrollTop()>i&&(i=$(window).scrollTop(),l+=1,e(sessionStorage.from,sessionStorage.room,l))}),void 0==sessionStorage.room&&(sessionStorage.room="all");var a=[],r="Всем",c=[],l=0,f=$("#messages"),d=$("#message_text"),m=$("#logout"),u=$("#to"),g=($(document.body),$(".file_upload").find("input"));void 0!=sessionStorage.text&&d.val(sessionStorage.text),void 0==sessionStorage.attached?sessionStorage.attached=JSON.stringify(c):(c=JSON.parse(sessionStorage.attached),_.each(c,function(e){$(".mess").append(magic.magic.fmsgmsg.format(e))})),$(window).unload(function(){""!=d.val().replace(/\ /g,"")?sessionStorage.text=d.val():sessionStorage.text=""}),$("#fromCloud").on("click",function(e){function t(e){$("main").append($(e).find(".files").addClass("files-insert")),$(".files-insert").removeClass("hidden")}$(".files-insert").remove(),$("section").hide(),$.get("/cloud",t),e.preventDefault()}),$("main").on("click",".files a",function(e){$(this).toggleClass("selectable"),e.preventDefault()}),$("main").on("click",".files #tomsg",function(e){$(".files-insert .selectable").each(function(e,t){o($(t).attr("href").replace("/upload/",""))}),$("section").show(),$(".files-insert").remove(),e.preventDefault()}),$("main").on("click",".files #closeCloud",function(e){$(".files-insert").remove(),$("section").show(),e.preventDefault()}),$("main").on("click",".files #removefiles",function(e){var t="Вы собираетесь удалить файлы из облака. Данное действие необратимо! Если файлы были приклеплены к сообщениям, то ссылки на них будут нерабочими. Вы действительно хотите удалить эти файлы?",o="Да, эти файлы больше не нужны мне",n="Отмена";magic["interface"].modal(t,o,n,function(){$(".selectable").each(function(e,t){var o=$(t);o.find(".c-nick").text()==sessionStorage.from|"fomin"==sessionStorage.from&&(o.remove(),socket.emit("removeFile",o.find(".c-file").text()))})},function(){return null},"error"),e.preventDefault()}),$("main").on("click",".files #upload_tocloud",function(e){g.attr("to","oblako"),g.click(),e.preventDefault()}),$("main").on("click","#upload_tomsg",function(e){g.attr("to","msg"),g.click(),e.preventDefault()}),$("input[name=upload]").on("change",function(e){login.isLogin()&&("oblako"==g.attr("to")?t(e,!1):t(e,!0))}),window.init=function(){function t(e){return $.get("/api/rooms",{user:e},function(e){$("nav").prepend($(e))}),!0}socket.emit("get_users"),t(sessionStorage.from),e(sessionStorage.from,sessionStorage.room,l),login.hideAuth()},m.click(function(){sessionStorage.clear(),magic["interface"].reloadPage()}),$("textarea").autoResize({animate:!0,extraSpace:0}),$(document).on({mouseenter:function(){$(this).children(".icon-trash-empty").show()},mouseleave:function(){$(this).children(".icon-trash-empty").hide()}},".mess .attached_tree"),$(".mess").on("click",".attached_tree .icon-trash-empty",function(e){var t=$(this).parent();c=_.without(c,t.attr("href").replace("/upload/","")),sessionStorage.attached=JSON.stringify(c),t.remove(),e.preventDefault()}),$("article").on("click",".msg .user",function(e){var t=$(this).parent();t.toggleClass("selectable"),e.preventDefault()}),$("#message_text").on("keypress",function(e){13==e.keyCode&e.shiftKey&&(n(),e.preventDefault())}),$("#message_btn").on("click",function(e){n(),e.preventDefault()}),$(document).on({mouseenter:function(){$(this).children(".icon-trash-empty").show(),$(this).children(".icon-save").show(),$(this).children(".icon-edit").show()},mouseleave:function(){$(this).children(".icon-trash-empty").hide(),$(this).children(".icon-save").hide(),$(this).children(".icon-edit").hide()}},".msg"),$("article").on("click",".msg .icon-edit",function(e){var t=$(this).parent();t.html(t.html().replace(t.attr("msg"),"")),t.children().is("textarea")||t.append("<textarea>"+t.attr("msg")+"</textarea>"),e.preventDefault()}),$("article").on("click",".msg .icon-save",function(e){var t=$(this).parent(),o=t.children("textarea").val();t.children("textarea").remove(),t.find("br").first().after(o),socket.emit("editMsg",t.attr("id"),o),t.attr("msg",o),e.preventDefault()}),$("article").on("keyup",".msg textarea",function(e){if(27==e.keyCode){var t=$(this).parent();t.children("textarea").remove(),t.find("br").first().after(t.attr("msg"))}}),$("article").on("click",".msg .icon-trash-empty",function(e){var t=$(this).parent();magic["interface"].modal("Вы действительно хотите удалить сообщение?","Да","Нет",function(){socket.emit("removeMsg",t.attr("id")),t.remove()},function(){},"error"),e.preventDefault()}),socket.on("connecting",function(){}),socket.on("connect",function(){}),socket.on("failed-login",function(){sessionStorage.loginde="failed",console.log("Верификация не пройдена, соединение не разорвано."),$(".laypass").find("input").removeClass("redBorder"),$(".laypass").find("input:text").addClass("redBorder")}),socket.on("failed-pass",function(){sessionStorage.loginde="failed",console.log("Верификация не пройдена, соединение не разорвано."),$(".laypass").find("input").removeClass("redBorder"),$(".laypass").find("input:password").addClass("redBorder")}),socket.on("success",function(){sessionStorage.loginde="success",$(".laypass").find("input").removeClass("redBorder"),console.log("Верификация пройдена"),init()}),socket.on("message",function(e,t){$(".msg").last().remove(),s(e,t),d.focus()}),socket.on("removeMsg",function(e){$('[id="'+e+'"]').remove()}),socket.on("add_users",function(e){_.each(e,function(e){u.append('<option value="'+e.from+'">'+e.title+"</option>"),"im"==sessionStorage.room&&$(".im").append('<a class="room" href="/{2}" to="{1}" room="{2}">{0} [{1}]</a>'.format(e.title,e.from,dia(sessionStorage.from,e.from))),a.push(e.from)}),$("[room="+sessionStorage.room+"]").addClass("activeRoom"),void 0!=$(".activeRoom").attr("to")&&$("#to").val($(".activeRoom").attr("to"))}),login.session(init)});